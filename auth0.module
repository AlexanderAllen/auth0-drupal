<?php
// Create a variable to store the path to this module
define('AUTH0_PATH', drupal_get_path('module', 'auth0'));



/**
 * Implements hook_theme_registry_alter(&$theme_registry)
 * We use this to override the login template with the one from block--user--login.tpl.php
 */
// function auth0_theme_registry_alter(&$theme_registry) {
//     global $theme_key;
//     $theme_registry_copy = $theme_registry;
//     _theme_process_registry($theme_registry_copy, 'phptemplate', 'theme_engine', $theme_key, AUTH0_PATH);
//     $theme_registry += array_diff_key($theme_registry_copy, $theme_registry);
// }






/**
 * Implements hook_user_delete
 * removes the user from the auth0_user table
 */
// function auth0_user_delete($account) {
//     db_delete('auth0_user')
//         ->condition('drupal_id', $account->uid, '=')
//         ->execute();
// }




/**
 * Implements hook_menu_alter
 * We use this to override the content of /user, which is the page for login and user management
 * @param  [type] $items [description]
 * @return [type]        [description]
 */
// function auth0_menu_alter(&$items) {
//     // Change /user page callback to our own
//     $items['user']['page callback'] = 'auth0_user_page';
//     // No need for register or retrieve password
//     unset($items['user/register']);
//     unset($items['user/password']);
// }

/**
 * This is the NEW page callback for /user/login, I've copied from user.pages.inc user_page function.
 * If the user is logged in, it goes to the normal user management, if not, it renders the auth0 login template
 */
// function auth0_user_page() {
//     global $user;
//     if ($user->uid) {
//         menu_set_active_item('user/' . $user->uid);
//         return menu_execute_active_handler(NULL, FALSE);
//     }
//     else {
//         return theme('auth0_login');
//     }
// }

/**
 * Implements hook_theme
 * Define the template to use for the /user action
 */
function auth0_theme() {

  global $base_root;
  
  return array(
    'auth0_login' => array(
      'template' => 'auth0-login',
      'variables' => array(
        'domain' => null,
        'clientID' => null,
        'state' => null,
        'showSignup' => null,
        'widgetCdn' => null,
        'loginCSS' => null,
        'callbackURL' => null,
        'lockExtraSettings' => '{}',
      ),
    ),
  );
}

function auth0_user_delete($account) {
  db_delete('auth0_user')
    ->condition('drupal_id', $account->uid->value)
    ->execute();
}